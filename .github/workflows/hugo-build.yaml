name: Hugo Build ğŸ”§

on:
  workflow_call:
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
    # Install global tools
    - name: Install Go  ğŸ› ï¸
      uses: actions/setup-go@v3
      with:
        go-version: '^1.18.3'
    - name: Install Hugo  ğŸ› ï¸
      uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: '0.101.0'

    # Get the site
    - name: Checkout workflow â¬‡ï¸
      uses: actions/checkout@v3
      with:
        repo: 'gauntface/workflow-static-site'
        path: 'workflow-static-site'

    # Install action dependencies
    - name: Install action Go Deps ğŸŒ
      run: |
        go install github.com/gauntface/go-html-asset-manager/v4/cmds/htmlassets@latest
        go install github.com/gauntface/go-html-asset-manager/v4/cmds/genimgs@latest
        go install github.com/tdewolff/minify/v2/cmd/minify@latest
    - name: Install action NPM Deps ğŸŒ
      run: |
        cd ./workflow-static-site/
        npm install -g eslint stylelint stylelint-config

    # Get the site
    - name: Checkout site â¬‡ï¸
      uses: actions/checkout@v3
      with:
        submodules: true
        path: 'hugo-site'

    # Install dependencies

    - name: Install NPM Deps ğŸŒ
      run: |
        cd ./hugo-site/
        npm install

    # Configure AWS for genimgs and publish
    - name: Configure AWS Credentials â˜ï¸
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-west-1

    # Do our work
    - name: Lint ğŸŒŸ
      if: always()
      run: eslint '.' && stylelint '**/*.css'
    - name: Build ğŸ”§
      if: always()
      run: hugo
    - name: Test ğŸ§ª
      if: always()
      run: npm run test --if-present
