name: Hugo Build 🔧

on:
  workflow_call:
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      VIMEO_TOKEN:

jobs:
  workflows:
    uses: gauntface/workflows-static-site/.github/workflows/lint.yaml@main

  build-and-test:
    runs-on: ubuntu-latest
    steps:
    # Install global tools
    - name: Install Go  🛠️
      uses: actions/setup-go@v3
      with:
        go-version: '^1.18.3'
    - name: Install Hugo  🛠️
      uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: '0.101.0'

    # Get the repos
    - name: Checkout workflow ⬇️
      uses: actions/checkout@v3
      with:
        repository: 'gauntface/workflows-static-site'
        path: 'workflows-static-site'
    - name: Checkout site ⬇️
      uses: actions/checkout@v3
      with:
        submodules: true
        path: 'hugo-site'

    # Install action dependencies
    - name: Install action Go Deps 🌎
      run: |
        go install github.com/gauntface/go-html-asset-manager/v4/cmds/htmlassets@latest
        go install github.com/gauntface/go-html-asset-manager/v4/cmds/genimgs@latest
        go install github.com/tdewolff/minify/v2/cmd/minify@latest
    - name: Install action NPM Deps 🌎
      run: |
        cd ./workflows-static-site/
        npm install

    # Install site dependencies
    - name: Install NPM Deps 🌎
      run: |
        cd ./hugo-site/
        npm install

    # Configure AWS for genimgs and publish
    - name: Configure AWS Credentials ☁️
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-west-1

    # Do our work
    - name: Build 🔧
      if: always()
      run: |
        cd ./hugo-site/
        hugo
        htmlassets --vimeo=$VIMEO_TOKEN
        minify -r --match=\\.html -o ./public ./public/*
    - name: Test 🧪
      if: always()
      run: |
        cd ./hugo-site/
        npm run test --if-present
